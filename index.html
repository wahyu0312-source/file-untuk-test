<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>東京精密発條株式会社システム</title>
  <link rel="icon" href="assets/tsh.png">

  <!-- Icons: Material Symbols (rounded) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;700;900" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Charts & QR (defer; chart akan lazy-init via IntersectionObserver) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <!-- Top Bar -->
  <nav class="nav">
    <button id="btnHamb" class="icon-btn show-md"><span class="material-symbols-rounded">menu</span></button>
    <div class="nav-left">
      <img src="assets/tsh.png" class="logo" alt="">
      <span class="brand">東京精密発條株式会社システム</span>
    </div>
    <div class="nav-right" id="navRight">
      <!-- Primary nav with icons -->
      <button id="btnToDash" class="btn ghost hidden">
        <span class="material-symbols-rounded">dashboard</span>ダッシュボード
      </button>
      <button id="btnToSales" class="btn ghost hidden">
        <span class="material-symbols-rounded">assignment_add</span>受注（営業）
      </button>
      <button id="btnToPlan" class="btn ghost hidden">
        <span class="material-symbols-rounded">precision_manufacturing</span>生産計画
      </button>
      <button id="btnToShip" class="btn ghost hidden">
        <span class="material-symbols-rounded">local_shipping</span>出荷予定
      </button>
      <button id="btnToInvoice" class="btn ghost hidden">
        <span class="material-symbols-rounded">request_quote</span>請求書
      </button>
      <button id="btnToStock" class="btn ghost hidden">
        <span class="material-symbols-rounded">inventory_2</span>在庫
      </button>
      <button id="btnToFinished" class="btn ghost hidden">
        <span class="material-symbols-rounded">inventory</span>完成品一覧
      </button>

      <!-- Dropdown: Laporan & Ekspor -->
      <details class="dropdown hidden" id="ddReports">
        <summary class="btn ghost">
          <span class="material-symbols-rounded">bar_chart</span>レポート
          <span class="material-symbols-rounded caret">expand_more</span>
        </summary>
        <div class="menu">
          <button class="menu-item" id="btnExportOrders">
            <span class="material-symbols-rounded">table</span>注文CSV
          </button>
          <button class="menu-item" id="btnExportShip">
            <span class="material-symbols-rounded">file_export</span>本日出荷CSV
          </button>
          <button class="menu-item" id="btnSalesExport">
            <span class="material-symbols-rounded">grid_on</span>営業CSV
          </button>
          <button class="menu-item" id="btnInvCSV">
            <span class="material-symbols-rounded">dataset</span>請求CSV（プレビュー）
          </button>
        </div>
      </details>

      <!-- Dropdown: 設定 -->
      <details class="dropdown hidden" id="ddSettings">
        <summary class="btn ghost">
          <span class="material-symbols-rounded">settings</span>設定
          <span class="material-symbols-rounded caret">expand_more</span>
        </summary>
        <div class="menu">
          <button id="btnAddUserWeb" class="menu-item hidden">
            <span class="material-symbols-rounded">person_add</span>ユーザー追加
          </button>
          <button id="btnChangePass" class="menu-item hidden">
            <span class="material-symbols-rounded">password</span>パス変更
          </button>
          <button id="btnShowStationQR" class="menu-item hidden">
            <span class="material-symbols-rounded">qr_code</span>工程QR
          </button>
          <button id="btnLogout" class="menu-item hidden">
            <span class="material-symbols-rounded">logout</span>ログアウト
          </button>
        </div>
      </details>

      <span id="userInfo" class="muted hide-sm"></span>
    </div>
  </nav>

  <!-- Auth -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2><span class="material-symbols-rounded">login</span> ログイン</h2>
      <div class="grid">
        <input id="inUser" placeholder="ユーザー名">
        <input id="inPass" type="password" placeholder="パスワード">
      </div>
      <details class="card" style="margin-top:.8rem">
        <summary><strong><span class="material-symbols-rounded s-ic">admin_panel_settings</span> 管理者: ユーザー追加</strong></summary>
        <div class="grid" style="margin-top:.6rem">
          <input id="nuUser" placeholder="ユーザー名">
          <input id="nuPass" type="password" placeholder="パスワード">
          <input id="nuName" placeholder="氏名">
          <select id="nuDept">
            <option value="営業">営業</option>
            <option value="生産技術">生産技術</option>
            <option value="生産管理部">生産管理部</option>
            <option value="製造部">製造部</option>
            <option value="検査部">検査部</option>
          </select>
          <select id="nuRole"><option value="member">member</option><option value="manager">manager</option><option value="admin">admin</option></select>
        </div>
        <button id="btnNewUser" class="btn ghost full">ユーザー追加</button>
        <p class="muted s">初回: <code>admin / admin123</code>（Users空なら自動作成。部門=生産技術）</p>
      </details>
      <button id="btnLogin" class="btn primary full" style="margin-top:.8rem">
        <span class="material-symbols-rounded">login</span> ログイン
      </button>
    </section>
  </main>

  <!-- Dashboard -->
  <main id="pageDash" class="container hidden">
    <!-- KPI band: responsif (TV ready) -->
    <section class="kpi-grid">
      <div class="kpi">
        <div class="kpi-head"><span class="material-symbols-rounded">inventory_2</span>完成品在庫</div>
        <div class="kpi-num" id="statFinished">-</div>
        <div class="muted s"><span id="statReady">-</span> 準備 / <span id="statShipped">-</span> 出荷済</div>
      </div>
      <div class="kpi">
        <div class="kpi-head"><span class="material-symbols-rounded">calendar_today</span>本日の出荷予定</div>
        <div id="listToday" class="list s"></div>
      </div>
      <div class="kpi">
        <div class="kpi-head"><span class="material-symbols-rounded">precision_manufacturing</span>工程内滞留（現在位置）</div>
        <div id="gridProc" class="grid grid-chips"></div>
      </div>
    </section>

    <!-- Orders table -->
    <section class="card" id="ordersSection">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">view_list</span> オーダー一覧</h3>
        <div class="row gap wrap">
          <input id="searchQ" placeholder="検索..." class="input" aria-label="検索">
          <details class="dropdown-inline">
            <summary class="btn ghost s"><span class="material-symbols-rounded">filter_alt</span>フィルター</summary>
            <div class="menu right">
              <label class="menu-item"><input type="checkbox" id="fOnlyWip"> WIPのみ</label>
              <label class="menu-item"><input type="checkbox" id="fOnlyReady"> 検査済/出荷準備</label>
              <button class="menu-item" id="btnRefresh">
                <span class="material-symbols-rounded">refresh</span>更新
              </button>
            </div>
          </details>
          <button class="btn ghost" onclick="window.print()">
            <span class="material-symbols-rounded">print</span>印刷
          </button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:55vh">
        <table class="table s" aria-describedby="ordersSection">
          <thead><tr>
            <th>注番</th><th>得意先</th><th>製番号</th><th>品名</th><th>品番</th><th>図番</th>
            <th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr></thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>
    </section>

    <!-- Charts (lazy) -->
    <section class="card">
      <header class="row-between"><h3><span class="material-symbols-rounded">insights</span> チャート</h3></header>
      <div class="chart-grid">
        <canvas class="chart-lazy" data-chart="monthly" id="chartMonthly" height="160" loading="lazy"></canvas>
        <canvas class="chart-lazy" data-chart="customer" id="chartCustomer" height="160" loading="lazy"></canvas>
        <canvas class="chart-lazy" data-chart="stock" id="chartStock" height="160" loading="lazy"></canvas>
      </div>
    </section>
  </main>

  <!-- Sales (営業) -->
  <main id="pageSales" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">assignment_add</span> 受注（営業）入力</h3>
        <div class="row gap wrap">
          <button class="btn primary" id="btnSalesSave"><span class="material-symbols-rounded">save</span>保存</button>
          <button class="btn" id="btnSalesDelete"><span class="material-symbols-rounded">delete</span>削除</button>
          <button class="btn ghost" id="btnPromote"><span class="material-symbols-rounded">upgrade</span>計画に変換</button>
        </div>
      </header>
      <div class="grid">
        <input id="so_id" placeholder="注番（編集用）">
        <input id="so_date" type="date" placeholder="受注日">
        <input id="so_cust" placeholder="得意先" list="dl_tokui">
        <input id="so_item" placeholder="品名" list="dl_hinmei">
        <input id="so_part" placeholder="品番" list="dl_hinban">
        <input id="so_drw"  placeholder="図番" list="dl_zuban">
        <input id="so_sei"  placeholder="製番号">
        <input id="so_qty"  type="number" placeholder="数量">
        <input id="so_req"  type="date" placeholder="希望納期">
        <input id="so_note" placeholder="備考">
      </div>
    </section>

    <section class="card">
      <header class="row-between"><h3><span class="material-symbols-rounded">view_list</span> 受注一覧</h3><input id="salesQ" placeholder="検索..." class="input"></header>
      <div class="table-wrap">
        <table class="table s">
          <thead><tr><th>注番</th><th>受注日</th><th>得意先</th><th>品名</th><th>品番/図番</th><th>数量</th><th>希望納期</th><th>状態</th><th>計画PO</th><th>更新</th></tr></thead>
          <tbody id="tbSales"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Plan -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">precision_manufacturing</span> 生産計画（生産現品票）</h3>
        <div class="row gap wrap">
          <button class="btn ghost" onclick="window.print()"><span class="material-symbols-rounded">print</span>印刷</button>
          <button class="btn ghost" id="btnPlanExport"><span class="material-symbols-rounded">database</span>エクスポート</button>
          <button class="btn ghost" id="btnPlanEdit"><span class="material-symbols-rounded">edit</span>編集</button>
          <button class="btn primary" id="btnCreateOrder"><span class="material-symbols-rounded">save</span>保存</button>
          <button class="btn" id="btnPlanDelete"><span class="material-symbols-rounded">delete</span>削除</button>
        </div>
      </header>
      <div class="grid">
        <input id="c_po" placeholder="注番（編集用）">
        <input id="c_tsuchi" placeholder="通知書番号">
        <input id="c_tokui" placeholder="得意先" list="dl_tokui">
        <input id="c_tokui_hin" placeholder="得意先品番">
        <input id="c_sei" placeholder="製番号">
        <input id="c_hinmei" placeholder="品名" list="dl_hinmei">
        <input id="c_hinban" placeholder="品番" list="dl_hinban">
        <input id="c_zuban" placeholder="図番" list="dl_zuban">
        <input id="c_kanri" placeholder="管理No">
      </div>
      <datalist id="dl_tokui"></datalist><datalist id="dl_hinmei"></datalist><datalist id="dl_hinban"></datalist><datalist id="dl_zuban"></datalist>
    </section>
  </main>

  <!-- Ship -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">local_shipping</span> 出荷予定 / 出荷確認</h3>
        <div class="row gap wrap">
          <button class="btn ghost" onclick="window.print()"><span class="material-symbols-rounded">print</span>印刷</button>
          <button class="btn ghost" id="btnShipExport"><span class="material-symbols-rounded">database</span>エクスポート</button>
          <button class="btn ghost" id="btnShipEdit"><span class="material-symbols-rounded">edit</span>編集</button>
          <button class="btn primary" id="btnSchedule"><span class="material-symbols-rounded">save</span>保存</button>
          <button class="btn" id="btnShipDelete"><span class="material-symbols-rounded">delete</span>削除</button>
        </div>
      </header>
      <div class="grid">
        <input id="s_po" placeholder="注番">
        <input id="s_date" type="date">
        <input id="s_qty" type="number" min="0" placeholder="数量">
        <input id="s_shipid" placeholder="Ship ID（編集/削除用）">
      </div>
      <div class="row gap">
        <button id="btnShipByPO" class="btn ghost grow"><span class="material-symbols-rounded">article</span>出荷確認書（注番）</button>
        <button id="btnShipByID" class="btn ghost grow"><span class="material-symbols-rounded">article</span>出荷確認書（Ship ID）</button>
      </div>
    </section>
  </main>

  <!-- Invoice -->
  <main id="pageInvoice" class="container hidden">
    <section class="card">
      <header class="row-between"><h3><span class="material-symbols-rounded">request_quote</span> 請求書作成</h3></header>
      <div class="grid">
        <input id="inv_customer" placeholder="得意先" list="dl_tokui">
        <input id="inv_from" type="date" placeholder="期間自">
        <input id="inv_to" type="date" placeholder="期間至">
        <input id="inv_date" type="date" placeholder="請求日">
        <input id="inv_currency" placeholder="通貨" value="JPY">
        <input id="inv_memo" placeholder="メモ">
      </div>
      <div class="row gap" style="margin-top:.6rem">
        <button id="btnInvPreview" class="btn ghost"><span class="material-symbols-rounded">summarize</span>集計（出荷済）</button>
        <button id="btnInvCreate" class="btn primary"><span class="material-symbols-rounded">print</span>請求書発行</button>
        <button id="btnInvPrint" class="btn ghost"><span class="material-symbols-rounded">print</span>印刷</button>
        <button id="btnInvCSV" class="btn ghost"><span class="material-symbols-rounded">dataset</span>CSV</button>
      </div>
    </section>

    <section class="card">
      <h3><span class="material-symbols-rounded">view_list</span> 請求明細（編集可：単価）</h3>
      <div class="table-wrap">
        <table class="table s" id="tblInv">
          <thead><tr><th>#</th><th>品名</th><th>品番</th><th>図番</th><th>数量</th><th>単価</th><th>金額</th><th>PO</th><th>出荷ID</th></tr></thead>
          <tbody id="invLines"></tbody>
          <tfoot><tr><td colspan="5"></td><td class="muted">小計</td><td id="invSub">0</td><td colspan="2"></td></tr>
                 <tr><td colspan="5"></td><td class="muted">税額(10%)</td><td id="invTax">0</td><td colspan="2"></td></tr>
                 <tr><td colspan="5"></td><td class="muted"><b>合計</b></td><td id="invTotal"><b>0</b></td><td colspan="2"></td></tr></tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Stock -->
  <main id="pageStock" class="container hidden">
    <section class="card" id="stockSection">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">inventory_2</span> 在庫</h3>
        <div class="row gap wrap">
          <input id="stockQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportStock"><span class="material-symbols-rounded">dataset</span>CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:55vh">
        <table class="table s">
          <thead><tr>
            <th>注番</th><th>得意先</th><th>製番号</th><th>品名</th><th>品番</th><th>図番</th>
            <th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr></thead>
          <tbody id="tbStock"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Finished -->
  <main id="pageFinished" class="container hidden">
    <section class="card" id="finishedSection">
      <header class="row-between">
        <h3><span class="material-symbols-rounded">inventory</span> 完成品一覧</h3>
        <div class="row gap wrap">
          <input id="finishedQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportFinished"><span class="material-symbols-rounded">dataset</span>CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:55vh">
        <table class="table s">
          <thead><tr>
            <th>注番</th><th>得意先</th><th>製番号</th><th>品名</th><th>品番</th><th>図番</th>
            <th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr></thead>
          <tbody id="tbFinished"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Dialogs -->
  <dialog id="dlgStationQR" class="paper">
    <div class="body"><h3>工程QR（現場掲示用）</h3><p class="muted s">フォーマット: <code>ST:工程名</code></p><div id="qrWrap" class="grid"></div></div>
    <footer class="row-end"><button class="btn" onclick="document.getElementById('dlgStationQR').close()">閉じる</button></footer>
  </dialog>

  <dialog id="dlgScan" class="paper">
    <div class="body">
      <h3>QRスキャン更新（注番: <span id="scanPO"></span>）</h3>
      <p class="muted s">工程QRを読み取ると切替され履歴に記録されます。</p>
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
      <div id="scanResult" class="muted s" style="margin-top:.5rem"></div>
    </div>
    <footer class="row-end"><button class="btn ghost" id="btnScanStart">開始</button><button class="btn" id="btnScanClose">閉じる</button></footer>
  </dialog>

  <dialog id="dlgHistory" class="paper"><div class="body"><h3>更新履歴</h3><div id="histBody"></div></div><footer class="row-end"><button class="btn" onclick="document.getElementById('dlgHistory').close()">閉じる</button></footer></dialog>
  <dialog id="dlgTicket" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()">印刷</button><button class="btn" onclick="document.getElementById('dlgTicket').close()">閉じる</button></footer></dialog>
  <dialog id="dlgShip" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()">印刷</button><button class="btn" onclick="document.getElementById('dlgShip').close()">閉じる</button></footer></dialog>
</body>
</html>
