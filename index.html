Below are complete, ready-to-paste files with the requested features:

* Kamera alternatif (BarcodeDetector, unggah gambar, dan scanner keyboard)
* Pewarnaan 状況 (status) sebagai badge di tabel & dokumen
* Highlight warna per-proses pada grid “工程内滞留（現在位置）”

---

# index.html

```html
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <title>東京精密発條株式会社システム</title>
  <link rel="icon" href="assets/tsh.png">
  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-left">
      <img src="assets/logo.png" class="logo" alt="">
      <span class="brand">東京精密発條株式会社システム</span>
    </div>
    <div class="nav-right">
      <button id="btnToDash" class="btn ghost hidden"><i data-lucide="layout-dashboard"></i>ダッシュ</button>
      <button id="btnToSales" class="btn ghost hidden"><i data-lucide="file-text"></i>受注</button>
      <button id="btnToPlan" class="btn ghost hidden"><i data-lucide="clipboard-list"></i>計画</button>
      <button id="btnToShip" class="btn ghost hidden"><i data-lucide="truck"></i>出荷</button>
      <button id="btnToInvoice" class="btn ghost hidden"><i data-lucide="file-invoice"></i>請求</button>
      <button id="btnToCharts" class="btn ghost hidden"><i data-lucide="pie-chart"></i>チャート</button>
      <button id="btnShowStationQR" class="btn ghost hidden"><i data-lucide="qr-code"></i>工程QR</button>
      <span id="userInfo" class="muted"></span>
      <button id="btnAddUserWeb" class="btn ghost hidden" title="ユーザー追加"><i data-lucide="user-plus"></i></button>
      <button id="btnChangePass" class="btn ghost hidden" title="パスワード変更"><i data-lucide="lock"></i></button>
      <button id="btnLogout" class="btn ghost hidden" title="ログアウト"><i data-lucide="log-out"></i></button>
    </div>
  </nav>

  <!-- Loading spinner -->
  <div id="loading" class="loading hidden"><div class="spinner"></div></div>

  <!-- Auth -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2>ログイン（スプレッドシートDB）</h2>
      <div class="grid m1">
        <input id="inUser" placeholder="ユーザー名">
        <input id="inPass" type="password" placeholder="パスワード">
      </div>
      <details class="card" style="margin-top:.8rem">
        <summary><strong>管理者: ユーザー追加</strong></summary>
        <div class="grid m1" style="margin-top:.6rem">
          <input id="nuUser" placeholder="ユーザー名">
          <input id="nuPass" type="password" placeholder="パスワード">
          <input id="nuName" placeholder="氏名">
          <select id="nuDept">
            <option value="営業">営業</option><option value="生産技術">生産技術</option>
            <option value="生産管理部">生産管理部</option><option value="製造部">製造部</option><option value="検査部">検査部</option>
          </select>
          <select id="nuRole"><option value="member">member</option><option value="manager">manager</option><option value="admin">admin</option></select>
        </div>
        <button id="btnNewUser" class="btn ghost full"><i data-lucide="user-plus"></i>ユーザー追加</button>
        <p class="muted s">初回: <code>admin / admin123</code>（Users空なら自動作成。部門=生産技術）</p>
      </details>
      <button id="btnLogin" class="btn primary full" style="margin-top:.8rem"><i data-lucide="log-in"></i>ログイン</button>
    </section>
  </main>

  <!-- Dashboard -->
  <main id="pageDash" class="container hidden">
    <section class="card" id="ordersSection">
      <header class="row-between">
        <h3><i data-lucide="list"></i> 生産一覧</h3>
        <div class="row gap">
          <input id="searchQ" placeholder="検索（注番・品番…）" class="input">
          <button class="btn ghost" id="btnExportOrders"><i data-lucide="download"></i>注文CSV</button>
          <button class="btn ghost" id="btnExportShip"><i data-lucide="download"></i>本日出荷CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:56vh">
        <table class="table s">
          <thead><tr>
            <th>注番</th><th>得意先</th><th>製番号</th><th>品名</th><th>品番</th><th>図番</th>
            <th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr></thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <header class="row-between">
        <h3><i data-lucide="activity"></i> ダッシュボード</h3>
        <div class="row gap">
          <button class="btn ghost" id="btnRefresh"><i data-lucide="refresh-ccw"></i>更新</button>
          <button class="btn ghost" onclick="window.print()"><i data-lucide="printer"></i>印刷</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="stat">
          <div class="muted s">完成品在庫</div>
          <div id="statFinished" class="stat-num">-</div>
          <div class="muted s"><span id="statReady">-</span> 準備 / <span id="statShipped">-</span> 出荷済</div>
        </div>
        <div class="tile">
          <div class="muted s">本日の出荷予定</div>
          <div id="listToday" class="list s"></div>
        </div>
        <div class="tile">
          <div class="muted s">工程内滞留（現在位置）</div>
          <div id="gridProc" class="grid grid-chips"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Sales -->
  <main id="pageSales" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i data-lucide="file-text"></i> 受注（営業）入力</h3>
        <div class="row gap">
          <button class="btn ghost" id="btnSalesExport"><i data-lucide="download"></i>エクスポート</button>
          <button class="btn primary" id="btnSalesSave"><i data-lucide="save"></i>保存</button>
          <button class="btn" id="btnSalesDelete"><i data-lucide="trash-2"></i>削除</button>
          <button class="btn ghost" id="btnPromote"><i data-lucide="arrow-right"></i>計画に変換</button>
        </div>
      </header>
      <div class="grid m1">
        <input id="so_id" placeholder="SO（編集用）">
        <input id="so_date" type="date" placeholder="受注日">
        <input id="so_cust" placeholder="得意先" list="dl_tokui">
        <input id="so_item" placeholder="品名" list="dl_hinmei">
        <input id="so_part" placeholder="品番" list="dl_hinban">
        <input id="so_drw" placeholder="図番" list="dl_zuban">
        <input id="so_sei" placeholder="製番号">
        <input id="so_qty" type="number" placeholder="数量">
        <input id="so_req" type="date" placeholder="希望納期">
        <input id="so_note" placeholder="備考">
      </div>
    </section>
    <section class="card">
      <header class="row-between"><h3><i data-lucide="list"></i> 受注一覧</h3><input id="salesQ" placeholder="検索..." class="input"></header>
      <div class="table-wrap">
        <table class="table s">
          <thead><tr><th>SO</th><th>受注日</th><th>得意先</th><th>品名</th><th>品番/図番</th><th>数量</th><th>希望納期</th><th>状態</th><th>注番</th><th>更新</th></tr></thead>
          <tbody id="tbSales"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Plan -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i data-lucide="clipboard-list"></i> 生産計画（生産現品票）</h3>
        <div class="row gap">
          <button class="btn ghost" onclick="window.print()"><i data-lucide="printer"></i>印刷</button>
          <button class="btn ghost" id="btnPlanExport"><i data-lucide="download"></i>エクスポート</button>
          <button class="btn ghost" id="btnPlanEdit"><i data-lucide="file-pen"></i>編集</button>
          <button class="btn primary" id="btnCreateOrder"><i data-lucide="save"></i>保存</button>
          <button class="btn" id="btnPlanDelete"><i data-lucide="trash-2"></i>削除</button>
        </div>
      </header>
      <div class="grid m1">
        <input id="c_po" placeholder="注番（編集用）">
        <input id="c_tsuchi" placeholder="通知書番号">
        <input id="c_tokui" placeholder="得意先" list="dl_tokui">
        <input id="c_tokui_hin" placeholder="得意先品番">
        <input id="c_sei" placeholder="製番号">
        <input id="c_hinmei" placeholder="品名" list="dl_hinmei">
        <input id="c_hinban" placeholder="品番" list="dl_hinban">
        <input id="c_zuban" placeholder="図番" list="dl_zuban">
        <input id="c_kanri" placeholder="管理No">
      </div>
      <datalist id="dl_tokui"></datalist><datalist id="dl_hinmei"></datalist><datalist id="dl_hinban"></datalist><datalist id="dl_zuban"></datalist>
    </section>
  </main>

  <!-- Ship -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i data-lucide="truck"></i> 出荷予定 / 出荷確認</h3>
        <div class="row gap">
          <button class="btn ghost" onclick="window.print()"><i data-lucide="printer"></i>印刷</button>
          <button class="btn ghost" id="btnShipExport"><i data-lucide="download"></i>エクスポート</button>
          <button class="btn ghost" id="btnShipEdit"><i data-lucide="file-pen"></i>編集</button>
          <button class="btn primary" id="btnSchedule"><i data-lucide="save"></i>保存</button>
          <button class="btn" id="btnShipDelete"><i data-lucide="trash-2"></i>削除</button>
        </div>
      </header>
      <div class="grid m1">
        <input id="s_po" placeholder="注番">
        <input id="s_date" type="date">
        <input id="s_qty" type="number" min="0" placeholder="数量">
        <input id="s_shipid" placeholder="出荷ID（編集/削除用）">
      </div>
      <div class="row gap" style="margin-top:.6rem">
        <button id="btnShipByPO" class="btn ghost grow"><i data-lucide="file-check-2"></i>出荷確認書（注番）</button>
        <button id="btnShipByID" class="btn ghost grow"><i data-lucide="file-check-2"></i>出荷確認書（出荷ID）</button>
      </div>
    </section>
  </main>

  <!-- Invoice -->
  <main id="pageInvoice" class="container hidden">
    <section class="card">
      <header class="row-between"><h3><i data-lucide="file-invoice"></i> 請求書作成</h3></header>
      <div class="grid m1">
        <input id="inv_customer" placeholder="得意先" list="dl_tokui">
        <input id="inv_from" type="date" placeholder="期間自">
        <input id="inv_to" type="date" placeholder="期間至">
        <input id="inv_date" type="date" placeholder="請求日">
        <input id="inv_currency" placeholder="通貨" value="JPY">
        <input id="inv_memo" placeholder="メモ">
      </div>
      <div class="row gap" style="margin-top:.6rem">
        <button id="btnInvPreview" class="btn ghost"><i data-lucide="calculator"></i>集計（出荷済）</button>
        <button id="btnInvCreate" class="btn primary"><i data-lucide="check-circle-2"></i>請求書発行</button>
        <button id="btnInvPrint" class="btn ghost"><i data-lucide="printer"></i>印刷</button>
        <button id="btnInvCSV" class="btn ghost"><i data-lucide="download"></i>CSV</button>
      </div>
    </section>
    <section class="card">
      <h3><i data-lucide="rows"></i> 請求明細（単価編集可）</h3>
      <div class="table-wrap">
        <table class="table s" id="tblInv">
          <thead><tr><th>#</th><th>品名</th><th>品番</th><th>図番</th><th>数量</th><th>単価</th><th>金額</th><th>注番</th><th>出荷ID</th></tr></thead>
          <tbody id="invLines"></tbody>
          <tfoot>
            <tr><td colspan="5"></td><td class="muted">小計</td><td id="invSub">0</td><td colspan="2"></td></tr>
            <tr><td colspan="5"></td><td class="muted">税額(10%)</td><td id="invTax">0</td><td colspan="2"></td></tr>
            <tr><td colspan="5"></td><td class="muted"><b>合計</b></td><td id="invTotal"><b>0</b></td><td colspan="2"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Station QR -->
  <dialog id="dlgStationQR" class="paper">
    <div class="body"><h3>工程QR（現場掲示用）</h3><p class="muted s">フォーマット: <code>ST:工程名</code></p><div id="qrWrap" class="grid"></div></div>
    <footer class="row-end"><button class="btn" onclick="document.getElementById('dlgStationQR').close()"><i data-lucide="x"></i>閉じる</button></footer>
  </dialog>

  <!-- Scan -->
  <dialog id="dlgScan" class="paper">
    <div class="body">
      <h3>QRスキャン更新（注番: <span id="scanPO"></span>）</h3>
      <p class="muted s">工程QRを読み取ると切替され履歴に記録されます。<br>※初回時はブラウザのカメラ許可を「許可」にしてください。</p>
      <video id="scanVideo" playsinline muted></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
      <div class="row gap" style="margin-top:.5rem">
        <select id="manualProc" class="grow"></select>
        <select id="manualStatus" class="grow"></select>
        <button id="btnManualApply" class="btn ghost"><i data-lucide="edit-3"></i>手動更新</button>
      </div>
      <!-- Tambahan: opsi gambar & scanner keyboard -->
      <div class="row gap" style="margin-top:.5rem">
        <input id="fileQR" type="file" accept="image/*" class="hidden">
        <button class="btn ghost" id="btnScanFromFile"><i data-lucide="image"></i>Dari Gambar</button>
        <label class="row gap s"><input id="kbMode" type="checkbox"> Scanner Keyboard</label>
      </div>
      <div id="scanResult" class="muted s" style="margin-top:.5rem"></div>
    </div>
    <footer class="row-end"><button class="btn ghost" id="btnScanStart"><i data-lucide="scan-line"></i>開始</button><button class="btn" id="btnScanClose"><i data-lucide="x"></i>閉じる</button></footer>
  </dialog>

  <!-- Docs -->
  <dialog id="dlgHistory" class="paper"><div class="body"><h3>更新履歴</h3><div id="histBody"></div></div><footer class="row-end"><button class="btn" onclick="document.getElementById('dlgHistory').close()"><i data-lucide="x"></i>閉じる</button></footer></dialog>
  <dialog id="dlgTicket" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()"><i data-lucide="printer"></i>印刷</button><button class="btn" onclick="document.getElementById('dlgTicket').close()"><i data-lucide="x"></i>閉じる</button></footer></dialog>
  <dialog id="dlgShip" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()"><i data-lucide="printer"></i>印刷</button><button class="btn" onclick="document.getElementById('dlgShip').close()"><i data-lucide="x"></i>閉じる</button></footer></dialog>

  <script>document.addEventListener("DOMContentLoaded", ()=>{ if(window.lucide){ lucide.createIcons(); } });</script>
</body>
</html>
```

---

# style.css

```css
:root{
  --bg:#f7f9fc; --card:#ffffff; --border:#e0e6f1; --ink:#222; --muted:#6b7a99;
  --primary:#2563eb; --primary-hover:#1d4ed8; --chip:#eff6ff; --radius:14px; --shadow:0 2px 6px rgba(0,0,0,0.05);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.5 'Inter','Segoe UI',Roboto,Helvetica,Arial,sans-serif}
.hidden{display:none!important}
.muted{color:var(--muted)}
.s{font-size:12px}
.row{display:flex;align-items:center}
.row-between{display:flex;align-items:center;justify-content:space-between}
.row-end{display:flex;justify-content:flex-end;gap:.5rem}
.row.gap{gap:.5rem}
.grow{flex:1}
.nav{position:sticky;top:0;z-index:5;display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;border-bottom:1px solid var(--border);background:#fff;box-shadow:var(--shadow)}
.logo{height:28px}
.brand{margin-left:.5rem;font-weight:700;font-size:15px}
.nav-right{display:flex;gap:.35rem;align-items:center;flex-wrap:wrap}
.container{padding:.8rem;max-width:1180px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem;box-shadow:var(--shadow)}
.card-tight{max-width:520px;margin:2rem auto}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.grid.m1{grid-template-columns:1fr}
.grid-3{display:grid;grid-template-columns:1fr;gap:1rem}
.grid-chips{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
@media(min-width:820px){
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  .grid-chips{grid-template-columns:repeat(3,1fr)}
  .grid.m1{grid-template-columns:1fr 1fr}
}
input, select, textarea{width:100%;padding:.75rem;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--ink)}
.input{width:210px}
.btn{padding:.55rem .9rem;border-radius:12px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;display:flex;align-items:center;gap:.3rem;font-size:13px}
.btn:hover{background:var(--primary-hover)}
.btn.ghost{background:#fff;border:1px solid var(--border);color:var(--ink)}
.btn.ghost:hover{background:#f3f6fb}
.btn.full{width:100%}
.tile{background:#fff;border:1px solid var(--border);border-radius:12px;padding:.8rem;box-shadow:var(--shadow)}
.stat-num{font-size:28px;font-weight:700}
.list > div{display:flex;justify-content:space-between;border-bottom:1px dashed #e6e9f2;padding:.2rem 0}
.table-wrap{overflow:auto;max-height:60vh;border:1px solid var(--border);border-radius:12px;background:#fff}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.6rem;border-bottom:1px solid #edf1f7}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:10px;background:var(--chip);color:#1b2141;border:1px solid #e2e7ff}
/* Badge warna status */
.badge.ok    { background:#e8f9ef; color:#166534; border-color:#bbf7d0; }
.badge.info  { background:#eef6ff; color:#1d4ed8; border-color:#c7d2fe; }
.badge.warn  { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
.badge.ship  { background:#f5f3ff; color:#6d28d9; border-color:#ddd6fe; }
.badge.hold  { background:#fffbeb; color:#92400e; border-color:#fde68a; }
.badge.ng    { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
.badge.muted { background:#f3f4f6; color:#374151; border-color:#e5e7eb; }

.grid-chip{border-radius:12px;padding:.6rem;text-align:center;border:1px solid #e2e8f0}
.grid-chip .s{opacity:.9}
.grid-chip .h{font-size:18px;font-weight:700}
/* Warna per-proses (highlight) */
.proc{background:#f8fafc}
.proc.laser   { background:#eef2ff; border-color:#c7d2fe; }
.proc.bend    { background:#ecfeff; border-color:#a5f3fc; }
.proc.frame   { background:#f0fdf4; border-color:#bbf7d0; }
.proc.sh-assy { background:#fff7ed; border-color:#fed7aa; }
.proc.sh-weld { background:#fef2f2; border-color:#fecaca; }
.proc.caulk   { background:#faf5ff; border-color:#e9d5ff; }
.proc.paint   { background:#fefce8; border-color:#fde68a; }
.proc.asm-in  { background:#e6fffa; border-color:#99f6e4; }
.proc.asm-ok  { background:#e0f2fe; border-color:#bae6fd; }
.proc.out     { background:#f1f5f9; border-color:#e2e8f0; }
.proc.inspect { background:#f0f9ff; border-color:#bae6fd; }

.paper{width:min(860px,96vw);border:0;padding:0;background:#fff;color:#000;border-radius:10px;box-shadow:var(--shadow)}
.paper .body{padding:16px}
.paper table{width:100%;border-collapse:collapse}
.paper th,.paper td{border:1px solid #555;padding:4px 6px;font-size:12px}
video#scanVideo{width:100%;max-height:48vh;border-radius:12px;background:#000}
.loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.6);backdrop-filter:saturate(1.2) blur(2px)}
.spinner{width:36px;height:36px;border:3px solid #dbe4ff;border-top-color:#2563eb;border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* Print A4 Portrait */
@media print{
  @page{ size:A4 portrait; margin:12mm }
  nav, .nav, .btn, .input, .row-between > .row, .loading{ display:none !important; }
  body{ background:#fff; }
  .paper{ box-shadow:none; width:auto }
  .container{ padding:0; }
}
```

---

# app.js

```js
/* ===== Config ===== */
const API_BASE = "https://script.google.com/macros/s/AKfycbwN3oi1TLBKcydOFdSLhydqxYIyLFMyYKQr3Z7Ikors5JnRL6IsWLfeEEajcZSftKdZLw/exec"; // << GANTI (Apps Script Web App /exec)
const API_KEY = ""; // optional
const PROCESSES = ['レーザ加工','曲げ加工','外枠組立','シャッター組立','シャッター溶接','コーキング','外枠塗装','組立（組立中）','組立（組立済）','外注','検査工程'];
const MANUAL_STATUSES = ['','生産開始','検査保留','検査済','出荷準備','出荷済','不良品（要リペア）'];
const STATION_RULES = {
  'レーザ加工': (o)=> ({ current_process:'レーザ加工' }),
  '曲げ工程': (o)=> ({ current_process:'曲げ加工' }),
  '外枠組立': (o)=> ({ current_process:'外枠組立' }),
  'シャッター組立': (o)=> ({ current_process:'シャッター組立' }),
  'シャッター溶接': (o)=> ({ current_process:'シャッター溶接' }),
  'コーキング': (o)=> ({ current_process:'コーキング' }),
  '外枠塗装': (o)=> ({ current_process:'外枠塗装' }),
  // 二段階：組立工程 → 組立（組立中）→（二回目）組立（組立済）
  '組立工程': (o)=> (o.current_process==='組立（組立中）' ? { current_process:'組立（組立済）' } : { current_process:'組立（組立中）' }),
  '検査工程': (o)=> (o.current_process==='検査工程' && !['検査保留','不良品（要リペア）','検査済'].includes(o.status) ? { current_process:'検査工程', status:'検査済' } : { current_process:'検査工程' }),
  '出荷工程': (o)=> (o.status==='出荷準備' ? { current_process:o.current_process||'検査工程', status:'出荷済' } : { current_process:'検査工程', status:'出荷準備' }),
  '外注' : (o)=> ({ current_process:'外注' })
};
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const fmtDT = s=> s? new Date(s).toLocaleString(): '';
const fmtD = s=> s? new Date(s).toLocaleDateString(): '';
let SESSION=null, CURRENT_PO=null, scanStream=null, scanTimer=null;
let INV_PREVIEW={info:null, lines:[], inv_id:''};
let ORDERS_CACHE=[];

/* ===== Helpers: Status & Process classes ===== */
function statusClass(s) {
  switch (s) {
    case '生産開始': return 'ok';
    case '検査保留': return 'hold';
    case '検査済':   return 'info';
    case '出荷準備': return 'warn';
    case '出荷済':   return 'ship';
    case '不良品（要リペア）': return 'ng';
    default: return 'muted';
  }
}
function procClass(p){
  if(p==='レーザ加工') return 'laser';
  if(p==='曲げ加工' || p==='曲げ工程') return 'bend';
  if(p==='外枠組立') return 'frame';
  if(p==='シャッター組立') return 'sh-assy';
  if(p==='シャッター溶接') return 'sh-weld';
  if(p==='コーキング') return 'caulk';
  if(p==='外枠塗装') return 'paint';
  if(p==='組立（組立中）') return 'asm-in';
  if(p==='組立（組立済）') return 'asm-ok';
  if(p==='外注') return 'out';
  if(p==='検査工程') return 'inspect';
  return '';
}

/* ===== API helpers with spinner ===== */
async function apiPost(action, body){
  showLoading(true);
  try{
    const payload={action,...body};
    if(API_KEY) payload.apiKey=API_KEY;
    const res=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const j=await res.json();
    if(!j.ok) throw new Error(j.error);
    return j.data;
  }finally{ showLoading(false); }
}
async function apiGet(params){
  showLoading(true);
  try{
    const url=API_BASE+'?'+new URLSearchParams(params).toString();
    const res=await fetch(url);
    const j=await res.json();
    if(!j.ok) throw new Error(j.error);
    return j.data;
  }finally{ showLoading(false); }
}
function showLoading(v){ $('#loading').classList.toggle('hidden',!v); }

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  // Nav
  $('#btnToDash').onclick = ()=>show('pageDash');
  $('#btnToSales').onclick= ()=>show('pageSales');
  $('#btnToPlan').onclick = ()=>show('pagePlan');
  $('#btnToShip').onclick = ()=>show('pageShip');
  $('#btnToInvoice').onclick = ()=>show('pageInvoice');
  $('#btnToCharts').onclick = ()=>{ show('pageCharts'); renderChartsPage(); };
  $('#btnShowStationQR').onclick = openStationQR;

  // Auth
  $('#btnLogin').onclick = onLogin;
  $('#btnNewUser').onclick = addUserFromLoginUI;
  $('#btnLogout').onclick = ()=>{ SESSION=null; localStorage.removeItem('erp_session'); location.reload(); };
  $('#btnChangePass').onclick = changePasswordUI;

  // Dashboard
  $('#btnRefresh').onclick = refreshAll;
  $('#searchQ').addEventListener('input', renderOrders);
  $('#btnExportOrders').onclick = exportOrdersCSV;
  $('#btnExportShip').onclick = exportShipCSV;

  // Sales
  $('#btnSalesSave').onclick = saveSalesUI;
  $('#btnSalesDelete').onclick = deleteSalesUI;
  $('#btnSalesExport').onclick = exportSalesCSV;
  $('#btnPromote').onclick = promoteSalesUI;
  $('#salesQ').addEventListener('input', renderSales);

  // Plan
  $('#btnCreateOrder').onclick = createOrderUI;
  $('#btnPlanExport').onclick = exportOrdersCSV;
  $('#btnPlanEdit').onclick = loadOrderForEdit;
  $('#btnPlanDelete').onclick = deleteOrderUI;

  // Ship
  $('#btnSchedule').onclick = scheduleUI;
  $('#btnShipExport').onclick = exportShipCSV;
  $('#btnShipEdit').onclick = loadShipForEdit;
  $('#btnShipDelete').onclick = deleteShipUI;
  $('#btnShipByPO').onclick = ()=>{ const po=$('#s_po').value.trim(); if(!po) return alert('注番入力'); openShipByPO(po); };
  $('#btnShipByID').onclick = ()=>{ const id=prompt('出荷ID:'); if(!id) return; openShipByID(id.trim()); };

  // Scan
  $('#btnScanStart').onclick = scanStart;
  $('#btnScanClose').onclick = scanClose;
  $('#btnManualApply').onclick = manualApply;
  fillManualSelectors();

  // Invoice
  $('#btnInvPreview').onclick = previewInvoiceUI;
  $('#btnInvCreate').onclick = createInvoiceUI;
  $('#btnInvPrint').onclick = ()=>window.print();
  $('#btnInvCSV').onclick = exportInvoiceCSV;

  // Charts page
  $('#btnChartsReload').onclick = renderChartsPage;

  // Restore session
  const saved=localStorage.getItem('erp_session');
  if(saved){ SESSION=JSON.parse(saved); enter(); } else show('authView');

  if(window.lucide){ lucide.createIcons(); }
});

function show(id){
  ['authView','pageDash','pageSales','pagePlan','pageShip','pageInvoice','pageCharts'].forEach(x=>document.getElementById(x)?.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  if(window.lucide){ lucide.createIcons(); }
}
function enter(){
  $('#userInfo').textContent = `${SESSION.full_name}・${SESSION.department}`; // fixed template string
  ['btnLogout','btnChangePass','btnToDash','btnToSales','btnToPlan','btnToShip','btnToInvoice','btnShowStationQR','btnToCharts'].forEach(id=>$('#'+id).classList.remove('hidden'));
  if (SESSION.role==='admin' || SESSION.department==='生産技術') $('#btnAddUserWeb').classList.remove('hidden'); else $('#btnAddUserWeb').classList.add('hidden');
  $('#btnAddUserWeb').onclick = openAddUserModal;
  show('pageDash');
  loadMasters();
  refreshAll();
}

/* ===== Auth ===== */
async function onLogin(){
  const u=$('#inUser').value.trim(), p=$('#inPass').value.trim();
  try{ const r=await apiPost('login',{username:u,password:p}); SESSION=r; localStorage.setItem('erp_session',JSON.stringify(r)); enter(); }
  catch(e){ alert(e.message||e); }
}
async function addUserFromLoginUI(){
  if(!SESSION) return alert('ログインしてください');
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術')) return alert('権限不足（生産技術）');
  const payload={ username:$('#nuUser').value.trim(), password:$('#nuPass').value.trim(), full_name:$('#nuName').value.trim(), department:$('#nuDept').value, role:$('#nuRole').value };
  if(!payload.username||!payload.password||!payload.full_name) return alert('必須項目');
  try{ await apiPost('createUser',{user:SESSION,payload}); alert('作成しました'); }catch(e){ alert(e.message||e); }
}
async function changePasswordUI(){
  if(!SESSION) return alert('ログインしてください');
  const oldPass=prompt('旧パスワード:'); if(oldPass===null) return;
  const newPass=prompt('新パスワード:'); if(newPass===null) return;
  try{ await apiPost('changePassword',{user:SESSION,oldPass,newPass}); alert('変更しました。再ログインしてください。'); SESSION=null; localStorage.removeItem('erp_session'); location.reload(); }
  catch(e){ alert(e.message||e); }
}

/* ===== Masters ===== */
async function loadMasters(){
  try{
    const m=await apiGet({action:'masters',types:'得意先,品名,品番,図番'});
    const fill=(id,arr)=> $(id).innerHTML=(arr||[]).map(v=>`<option value="${v}"></option>`).join('');
    fill('#dl_tokui',m['得意先']);
    fill('#dl_hinmei',m['品名']);
    fill('#dl_hinban',m['品番']);
    fill('#dl_zuban',m['図番']);
  }catch(e){ console.warn(e); }
}

/* ===== Dashboard ===== */
async function refreshAll(keep=false){
  try{
    const s=await apiGet({action:'stock'});
    $('#statFinished').textContent=s.finishedStock;
    $('#statReady').textContent=s.ready;
    $('#statShipped').textContent=s.shipped;

    const today=await apiGet({action:'todayShip'});
    $('#listToday').innerHTML = today.length? today.map(r=>`<div><span>${r.po_id}</span><span>${fmtD(r.scheduled_date)}・${r.qty}</span></div>`).join(''):'<div class="muted">本日予定なし</div>';

    const loc=await apiGet({action:'locSnapshot'});
    $('#gridProc').innerHTML = PROCESSES.map(p=> `
      <div class="grid-chip proc ${procClass(p)}">
        <div class="muted s">${p}</div>
        <div class="h">${loc[p]||0}</div>
      </div>`
    ).join('');

    if(!keep) $('#searchQ').value='';
    await renderOrders();
    await renderSales();
  }catch(e){ console.error(e); }
}

async function listOrders(){
  const q=$('#searchQ').value.trim();
  const rows=await apiGet({action:'listOrders',q});
  ORDERS_CACHE=rows;
  return rows;
}

async function renderOrders(){
  const rows=await listOrders();
  $('#tbOrders').innerHTML = rows.map(r=> `
    <tr>
      <td><b>${r.po_id}</b></td>
      <td>${r['得意先']||''}</td>
      <td>${r['製番号']||''}</td>
      <td>${r['品名']||''}</td>
      <td>${r['品番']||''}</td>
      <td>${r['図番']||''}</td>
      <td><span class="badge ${statusClass(r.status)}">${r.status}</span></td>
      <td>
        <select class="s selProc" data-po="${r.po_id}">
          ${PROCESSES.map(p=>`<option ${p===r.current_process?'selected':''}>${p}</option>`).join('')}
        </select>
      </td>
      <td class="s muted">${fmtDT(r.updated_at)}</td>
      <td class="s muted">${r.updated_by||''}</td>
      <td class="s">
        <button class="btn ghost s" onclick="openTicket('${r.po_id}')"><i data-lucide="file-badge-2"></i>票</button>
        <button class="btn ghost s" onclick="startScanFor('${r.po_id}')"><i data-lucide="scan-line"></i>更新</button>
        <button class="btn ghost s" onclick="openShipByPO('${r.po_id}')"><i data-lucide="file-check-2"></i>出荷票</button>
        <button class="btn ghost s" onclick="openHistory('${r.po_id}')"><i data-lucide="history"></i>履歴</button>
      </td>
    </tr>`).join('');

  $$('.selProc').forEach(sel=>{
    sel.onchange = async (e)=>{
      const po=e.target.dataset.po, val=e.target.value;
      const row=ORDERS_CACHE.find(x=>x.po_id===po);
      const prev=row.current_process;
      row.current_process=val;
      e.target.disabled=true;
      try{ await apiPost('updateOrder',{po_id:po,updates:{current_process:val},user:SESSION}); }
      catch(err){ alert(err.message||err); row.current_process=prev; e.target.value=prev; }
      finally{ e.target.disabled=false; }
    };
  });
  if(window.lucide){ lucide.createIcons(); }
}

/* ===== Sales ===== */
async function renderSales(){
  const q=$('#salesQ').value?.trim()||'';
  const rows=await apiGet({action:'listSales',q});
  $('#tbSales').innerHTML = rows.map(r=> `
    <tr>
      <td>${r.so_id}</td>
      <td class="s muted">${fmtD(r['受注日'])}</td>
      <td>${r['得意先']||''}</td>
      <td>${r['品名']||''}</td>
      <td>${(r['品番']||'')}/${(r['図番']||'')}</td>
      <td>${r['数量']||0}</td>
      <td class="s muted">${fmtD(r['希望納期'])}</td>
      <td><span class="badge ${statusClass(r.status||'')}">${r.status||''}</span></td>
      <td>${r['linked_po_id']||''}</td>
      <td class="s muted">${fmtDT(r['更新']||r['updated_at'])}</td>
    </tr>`).join('');
}
async function saveSalesUI(){
  const p={'受注日':$('#so_date').value,'得意先':$('#so_cust').value,'品名':$('#so_item').value,'品番':$('#so_part').value,'図番':$('#so_drw').value,'製番号':$('#so_sei').value,'数量':$('#so_qty').value,'希望納期':$('#so_req').value,'備考':$('#so_note').value};
  const so=$('#so_id').value.trim();
  try{
    if(so){ await apiPost('updateSalesOrder',{so_id:so,updates:p,user:SESSION}); alert('受注を更新しました'); }
    else { const r=await apiPost('createSalesOrder',{payload:p,user:SESSION}); alert('受注登録: '+r.so_id); $('#so_id').value=r.so_id; }
    renderSales();
  }catch(e){ alert(e.message||e); }
}
async function deleteSalesUI(){
  const so=$('#so_id').value.trim(); if(!so) return alert('SO入力'); if(!confirm('削除しますか？')) return;
  try{ const r=await apiPost('deleteSalesOrder',{so_id:so,user:SESSION}); alert('削除: '+r.deleted); renderSales(); }
  catch(e){ alert(e.message||e); }
}
async function promoteSalesUI(){
  const so=$('#so_id').value.trim(); if(!so) return alert('SO入力');
  try{ const r=await apiPost('promoteSalesToPlan',{so_id:so,user:SESSION}); alert('生産計画を作成: '+r.po_id); refreshAll(); }catch(e){ alert(e.message||e); }
}
async function exportSalesCSV(){ const rows=await apiGet({action:'listSales'}); downloadCSV('sales_orders.csv', rows); }

/* ===== Plan ===== */
async function createOrderUI(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術'||SESSION.department==='生産管理部')) return alert('権限不足');
  const p={'通知書番号':$('#c_tsuchi').value.trim(),'得意先':$('#c_tokui').value.trim(),'得意先品番':$('#c_tokui_hin').value.trim(),'製番号':$('#c_sei').value.trim(),'品名':$('#c_hinmei').value.trim(),'品番':$('#c_hinban').value.trim(),'図番':$('#c_zuban').value.trim(),'管理No':$('#c_kanri').value.trim()};
  const editingPo=$('#c_po').value.trim();
  try{
    if(editingPo){ await apiPost('updateOrder',{po_id:editingPo,updates:p,user:SESSION}); alert('編集保存しました'); }
    else{ const r=await apiPost('createOrder',{payload:p,user:SESSION}); alert('作成: '+r.po_id); $('#c_po').value=r.po_id; }
    refreshAll();
  }catch(e){ alert(e.message||e); }
}
async function loadOrderForEdit(){
  const po=$('#c_po').value.trim(); if(!po) return alert('注番入力');
  try{
    const o=await apiGet({action:'ticket',po_id:po});
    $('#c_tsuchi').value=o['通知書番号']||''; $('#c_tokui').value=o['得意先']||''; $('#c_tokui_hin').value=o['得意先品番']||''; $('#c_sei').value=o['製番号']||''; $('#c_hinmei').value=o['品名']||''; $('#c_hinban').value=o['品番']||''; $('#c_zuban').value=o['図番']||''; $('#c_kanri').value=o['管理No']||''; alert('読み込み完了。');
  }catch(e){ alert(e.message||e); }
}
async function deleteOrderUI(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術'||SESSION.department==='生産管理部')) return alert('権限不足');
  const po=$('#c_po').value.trim(); if(!po) return alert('注番入力'); if(!confirm('削除しますか？')) return;
  try{ const r=await apiPost('deleteOrder',{po_id:po,user:SESSION}); alert('削除:'+r.deleted); refreshAll(); }
  catch(e){ alert(e.message||e); }
}

/* ===== Ship ===== */
async function scheduleUI(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術'||SESSION.department==='生産管理部')) return alert('権限不足');
  const po=$('#s_po').value.trim(), dateIso=$('#s_date').value, qty=$('#s_qty').value; if(!po||!dateIso) return alert('注番と日付');
  try{
    const shipId=$('#s_shipid').value.trim();
    if (shipId){ await apiPost('updateShipment',{ship_id:shipId,updates:{po_id:po,scheduled_date:dateIso,qty:qty},user:SESSION}); alert('出荷予定を編集しました'); }
    else{ const r=await apiPost('scheduleShipment',{po_id:po,dateIso,qty,user:SESSION}); alert('登録: '+r.ship_id); }
    refreshAll(true);
  }catch(e){ alert(e.message||e); }
}
async function loadShipForEdit(){
  const sid=$('#s_shipid').value.trim(); if(!sid) return alert('出荷ID入力');
  try{ const d=await apiGet({action:'shipById',ship_id:sid}); $('#s_po').value=d.shipment.po_id||''; $('#s_date').value = d.shipment.scheduled_date? new Date(d.shipment.scheduled_date).toISOString().slice(0,10):''; $('#s_qty').value=d.shipment.qty||0; alert('読み込み完了。'); }
  catch(e){ alert(e.message||e); }
}
async function deleteShipUI(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術'||SESSION.department==='生産管理部')) return alert('権限不足');
  const sid=$('#s_shipid').value.trim(); if(!sid) return alert('出荷ID入力'); if(!confirm('削除しますか？')) return;
  try{ const r=await apiPost('deleteShipment',{ship_id:sid,user:SESSION}); alert('削除:'+r.deleted); refreshAll(true); }
  catch(e){ alert(e.message||e); }
}

/* ===== Docs ===== */
async function openTicket(po_id){
  try{
    const o=await apiGet({action:'ticket',po_id});
    const body=`<h3>生産現品票</h3><table>
      <tr><th>管理No</th><td>${o['管理No']||'-'}</td><th>通知書番号</th><td>${o['通知書番号']||'-'}</td></tr>
      <tr><th>得意先</th><td>${o['得意先']||''}</td><th>得意先品番</th><td>${o['得意先品番']||''}</td></tr>
      <tr><th>製番号</th><td>${o['製番号']||''}</td><th>投入日</th><td>${o['created_at']?new Date(o['created_at']).toLocaleDateString():'-'}</td></tr>
      <tr><th>品名</th><td>${o['品名']||''}</td><th>品番/図番</th><td>${(o['品番']||'')} / ${(o['図番']||'')}</td></tr>
      <tr><th>工程</th><td colspan="3">${o.current_process} <span class="badge ${statusClass('info')} ${'proc '+procClass(o.current_process)}" style="margin-left:.4rem">工程</span></td></tr>
      <tr><th>状態</th><td colspan="3"><span class="badge ${statusClass(o.status)}">${o.status}</span> <span class="muted s" style="margin-left:.4rem">更新: ${fmtDT(o.updated_at)} / ${o.updated_by||''}</span></td></tr>
    </table>`;
    showDoc('dlgTicket',body);
  }catch(e){ alert(e.message||e); }
}
function showShipDoc(s,o){
  const dt=s.scheduled_date? new Date(s.scheduled_date):null;
  const body=`<h3>出荷確認書</h3><table>
    <tr><th>得意先</th><td>${o['得意先']||''}</td><th>出荷日</th><td>${dt?dt.toLocaleDateString():'-'}</td></tr>
    <tr><th>品名</th><td>${o['品名']||''}</td><th>品番/図番</th><td>${(o['品番']||'')} / ${(o['図番']||'')}</td></tr>
    <tr><th>注番</th><td>${o.po_id||s.po_id}</td><th>数量</th><td>${s.qty||0}</td></tr>
    <tr><th>出荷ステータス</th><td colspan="3"><span class="badge ${statusClass(s.status)}">${s.status}</span></td></tr>
  </table>`;
  showDoc('dlgShip',body);
}
async function openShipByPO(po_id){ try{ const d=await apiGet({action:'shipByPo',po_id}); showShipDoc(d.shipment,d.order);}catch(e){ alert(e.message||e);} }
async function openShipByID(id){ try{ const d=await apiGet({action:'shipById',ship_id:id}); showShipDoc(d.shipment,d.order);}catch(e){ alert(e.message||e);} }
function showDoc(id,html){ const dlg=document.getElementById(id); dlg.querySelector('.body').innerHTML=html; dlg.showModal(); }

/* ===== Export ===== */
async function exportOrdersCSV(){ const rows=await apiGet({action:'listOrders'}); downloadCSV('orders.csv',rows); }
async function exportShipCSV(){ const rows=await apiGet({action:'todayShip'}); downloadCSV('ship_today.csv',rows); }
function downloadCSV(name,rows){ if(!rows||!rows.length) return downloadFile(name,''); const headers=Object.keys(rows[0]); const csv=[headers.join(',')].concat(rows.map(r=> headers.map(h=> String(r[h]??'').replaceAll('"','""')).map(v=>`"${v}"`).join(','))).join('\n'); downloadFile(name,csv); }
function downloadFile(name,content){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/csv'})); a.download=name; a.click(); }

/* ===== Station QR (include 外注) ===== */
function openStationQR(){
  const wrap = $('#qrWrap'); wrap.innerHTML = '';
  const stations = ['レーザ加工','曲げ工程','外枠組立','シャッター組立','シャッター溶接','コーキング','外枠塗装','組立工程','検査工程','出荷工程','外注'];
  stations.forEach((st)=>{
    const div = document.createElement('div');
    div.className = 'tile';
    div.innerHTML = `
      <div class="row-between"><b>${st}</b><a class="btn ghost s" target="_blank"><i data-lucide="download"></i>PNG</a></div>
      <div class="qr-holder" style="background:#fff;border:1px solid #e3e6ef;border-radius:8px;display:inline-block"></div>
      <div class="s muted">内容: ST:${st}</div>`;
    wrap.appendChild(div);
    const holder=div.querySelector('.qr-holder');
    const link=div.querySelector('a');
    new QRCode(holder,{ text:'ST:'+st, width:200, height:200, correctLevel:QRCode.CorrectLevel.M });
    setTimeout(()=>{
      const cvs=holder.querySelector('canvas');
      const img=holder.querySelector('img');
      let url='';
      if(cvs&&cvs.toDataURL) url=cvs.toDataURL('image/png');
      else if(img&&img.src) url=img.src;
      if(url){ link.href=url; link.download=`ST-${st}.png`; } else link.remove();
      if(window.lucide){ lucide.createIcons(); }
    },50);
  });
  document.getElementById('dlgStationQR').showModal();
}

/* ===== Scan: kamera + opsi file + keyboard ===== */
let KB_BUFFER = '', KB_TIMER = null;
function attachKeyboardScanner(enable = true) {
  const handler = (e) => {
    if ($('#kbMode')?.checked !== true) return;
    if (KB_TIMER) clearTimeout(KB_TIMER);
    if (e.key === 'Enter') {
      const txt = KB_BUFFER.trim();
      KB_BUFFER = '';
      if (txt) handleScannedText(txt);
      return;
    }
    if (e.key.length === 1) KB_BUFFER += e.key;
    KB_TIMER = setTimeout(() => { KB_BUFFER = ''; }, 600);
  };
  if (enable) { window.addEventListener('keydown', handler); attachKeyboardScanner._handler = handler; }
  else if (attachKeyboardScanner._handler) { window.removeEventListener('keydown', attachKeyboardScanner._handler); attachKeyboardScanner._handler = null; }
}

async function tryBarcodeDetectorOnce(videoEl, canvasEl) {
  if (!('BarcodeDetector' in window)) return null;
  try {
    const detector = new BarcodeDetector({ formats: ['qr_code'] });
    const ctx = canvasEl.getContext('2d');
    canvasEl.width = videoEl.videoWidth; canvasEl.height = videoEl.videoHeight;
    ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
    const bmp = await createImageBitmap(canvasEl);
    const codes = await detector.detect(bmp);
    return (codes && codes[0]?.rawValue) ? codes[0].rawValue : null;
  } catch { return null; }
}

async function scanFromFile(file) {
  const img = new Image();
  const url = URL.createObjectURL(file);
  await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });
  const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight;
  const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0);
  const id = ctx.getImageData(0, 0, c.width, c.height);
  const code = jsQR(id.data, c.width, c.height);
  URL.revokeObjectURL(url);
  return code ? code.data.trim() : '';
}

async function handleScannedText(text) {
  if (!text) return;
  $('#scanResult').textContent = '読み取り: ' + text;
  if (/^ST:/.test(text) && CURRENT_PO) {
    const station = text.slice(3);
    const rule = STATION_RULES[station];
    if (!rule) { $('#scanResult').textContent = '未知のステーション: ' + station; return; }
    try{
      const cur = ORDERS_CACHE.find(x=>x.po_id===CURRENT_PO) || await apiGet({action:'ticket',po_id:CURRENT_PO});
      const updates = rule(cur);
      $('#scanResult').textContent = '更新中...';
      await apiPost('updateOrder',{po_id:CURRENT_PO,updates,user:SESSION});
      $('#scanResult').textContent = `更新完了: ${CURRENT_PO} → ${updates.status||'(状態変更なし)'} / ${updates.current_process||cur.current_process}`;
      refreshAll(true);
    }catch(e){ $('#scanResult').textContent='更新失敗: '+(e.message||e); }
  }
}

function startScanFor(po_id){
  CURRENT_PO=po_id;
  $('#scanPO').textContent=po_id;
  $('#scanResult').textContent='開始を押してQRを読み取ってください（iOSはSafari推奨）。';
  document.getElementById('dlgScan').showModal();
}

async function scanStart(){
  try{
    if(location.protocol!=='https:') { alert('カメラ利用にはHTTPSが必要です（GitHub Pages/自社ドメイン推奨）'); return; }
    if(scanStream) return; // already

    const v=$('#scanVideo'), c=$('#scanCanvas'), ctx=c.getContext('2d');
    const st=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    scanStream=st; v.srcObject=st; await v.play();

    // tombol unggah gambar
    $('#btnScanFromFile').onclick = () => $('#fileQR').click();
    $('#fileQR').onchange = async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const txt = await scanFromFile(f);
      if (txt) handleScannedText(txt); else $('#scanResult').textContent = 'Tidak terdeteksi dari gambar.';
    };

    // keyboard mode
    $('#kbMode').onchange = (e)=> attachKeyboardScanner(e.target.checked);
    attachKeyboardScanner($('#kbMode').checked === true);

    scanTimer=setInterval(async ()=>{
      if(v.readyState<2) return;
      const bd = await tryBarcodeDetectorOnce(v, c);
      if (bd) { handleScannedText(bd); return; }
      c.width=v.videoWidth; c.height=v.videoHeight;
      ctx.drawImage(v,0,0,c.width,c.height);
      const code=jsQR(ctx.getImageData(0,0,c.width,c.height).data,c.width,c.height);
      if(code && code.data) handleScannedText(code.data.trim());
    }, 400);
  }catch(e){
    alert('カメラ起動失敗: '+(e.message||e)+'\nブラウザのロックアイコン→サイトの設定→カメラ→「許可」を選択してください。');
  }
}

function scanClose(){
  clearInterval(scanTimer); scanTimer=null;
  attachKeyboardScanner(false);
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  document.getElementById('dlgScan').close();
}

function fillManualSelectors(){
  $('#manualProc').innerHTML = PROCESSES.map(p=>`<option value="${p}">${p}</option>`).join('');
  $('#manualStatus').innerHTML = MANUAL_STATUSES.map(s=>`<option value="${s}">${s||'（変更なし）'}</option>`).join('');
}
async function manualApply(){
  if(!CURRENT_PO) return alert('注番が未選択');
  const proc=$('#manualProc').value, st=$('#manualStatus').value; const updates={};
  if(proc) updates.current_process=proc; if(st) updates.status=st;
  try{ await apiPost('updateOrder',{po_id:CURRENT_PO,updates,user:SESSION}); alert('手動更新しました'); refreshAll(true); }
  catch(e){ alert(e.message||e); }
}

/* ===== History ===== */
async function openHistory(po_id){
  try{
    const logs=await apiGet({action:'history',po_id});
    const html = logs.length? `
      <table><thead><tr><th>時刻</th><th>旧状態</th><th>新状態</th><th>旧工程</th><th>新工程</th><th>更新者</th><th>備考</th></tr></thead>
      <tbody>${logs.map(l=>`<tr><td>${fmtDT(l.timestamp)}</td><td>${l.prev_status||''}</td><td><span class="badge ${statusClass(l.new_status)}">${l.new_status||''}</span></td><td>${l.prev_process||''}</td><td>${l.new_process||''}</td><td>${l.updated_by||''}</td><td>${l.note||''}</td></tr>`).join('')}</tbody></table>`
      : '<div class="muted">履歴なし</div>';
    $('#histBody').innerHTML=html; document.getElementById('dlgHistory').showModal();
  }catch(e){ alert(e.message||e); }
}

/* ===== Add user ===== */
function openAddUserModal(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術')) return alert('権限不足');
  const html=`<h3>ユーザー追加</h3>
    <div class="grid m1">
      <input id="au_username" placeholder="ユーザー名">
      <input id="au_password" type="password" placeholder="パスワード">
      <input id="au_fullname" placeholder="氏名">
      <select id="au_dept"><option>営業</option><option>生産技術</option><option>生産管理部</option><option>製造部</option><option>検査部</option></select>
      <select id="au_role"><option>member</option><option>manager</option><option>admin</option></select>
    </div>
    <div class="row-end" style="margin-top:.6rem"><button class="btn primary" id="au_save"><i data-lucide="save"></i>保存</button></div>`;
  const dlg=document.getElementById('dlgTicket'); dlg.querySelector('.body').innerHTML=html; dlg.showModal();
  document.getElementById('au_save').onclick=async ()=>{
    const payload={ username:$('#au_username').value.trim(), password:$('#au_password').value.trim(), full_name:$('#au_fullname').value.trim(), department:$('#au_dept').value, role:$('#au_role').value };
    if(!payload.username||!payload.password||!payload.full_name) return alert('必須項目');
    try{ await apiPost('createUser',{user:SESSION,payload}); alert('作成しました'); dlg.close(); }catch(e){ alert(e.message||e); }
  };
  if(window.lucide){ lucide.createIcons(); }
}

/* ===== Invoice (per-shipment lines) ===== */
function recalcInvoiceTotals(){
  let sub=0;
  [...document.querySelectorAll('#invLines tr')].forEach(tr=>{
    const qty=Number(tr.querySelector('.q')?.value||0);
    const up =Number(tr.querySelector('.p')?.value||0);
    const amt=qty*up; tr.querySelector('.a').textContent=amt.toLocaleString(); sub+=amt;
  });
  const tax=Math.round(sub*0.1), total=sub+tax;
  $('#invSub').textContent=sub.toLocaleString();
  $('#invTax').textContent=tax.toLocaleString();
  $('#invTotal').textContent=total.toLocaleString();
  INV_PREVIEW.info = INV_PREVIEW.info || {};
  INV_PREVIEW.info['小計']=sub; INV_PREVIEW.info['税額']=tax; INV_PREVIEW.info['合計']=total;
  INV_PREVIEW.lines = [...document.querySelectorAll('#invLines tr')].map(tr=>({ 行No:Number(tr.dataset.no), 品名:tr.dataset.hinmei, 品番:tr.dataset.hinban, 図番:tr.dataset.zuban, 数量:Number(tr.querySelector('.q').value||0), 単価:Number(tr.querySelector('.p').value||0), 出荷ID:tr.dataset.shipid, PO:tr.dataset.po }));
}
async function previewInvoiceUI(){
  const cust=$('#inv_customer').value.trim(), from=$('#inv_from').value, to=$('#inv_to').value; if(!from||!to) return alert('期間を指定してください');
  try{
    const d=await apiGet({action:'previewInvoice',customer:cust,from:from,to:to});
    INV_PREVIEW={info:d.info, lines:d.lines, inv_id:''};
    $('#invLines').innerHTML = d.lines.map(l=> `
      <tr data-no="${l.行No}" data-hinmei="${l.品名}" data-hinban="${l.品番}" data-zuban="${l.図番}" data-shipid="${l.出荷ID}" data-po="${l.PO}">
        <td>${l.行No}</td>
        <td>${l.品名}</td>
        <td>${l.品番}</td>
        <td>${l.図番}</td>
        <td><input class="q" type="number" value="${l.数量||0}" style="width:90px"></td>
        <td><input class="p" type="number" value="${l.単価||0}" style="width:90px"></td>
        <td class="a">0</td>
        <td class="s">${l.PO}</td>
        <td class="s">${l.出荷ID}</td>
      </tr>`).join('');
    $('#inv_customer').value = d.info['得意先']||cust;
    $('#inv_currency').value = d.info['通貨']||'JPY';
    if(!$('#inv_date').value) $('#inv_date').value = new Date().toISOString().slice(0,10);
    document.querySelectorAll('#invLines input').forEach(el=> el.oninput=recalcInvoiceTotals);
    recalcInvoiceTotals();
  }catch(e){ alert(e.message||e); }
}
async function createInvoiceUI(){
  if(!(SESSION.role==='admin'||SESSION.department==='生産技術'||SESSION.department==='生産管理部')) return alert('権限不足');
  if(!INV_PREVIEW.lines.length) return alert('明細がありません。集計してください。');
  INV_PREVIEW.info = { ...(INV_PREVIEW.info||{}), '得意先': $('#inv_customer').value.trim(), '期間自': $('#inv_from').value, '期間至': $('#inv_to').value, '請求日': $('#inv_date').value, '通貨': $('#inv_currency').value.trim()||'JPY', 'メモ': $('#inv_memo').value.trim() };
  try{ const r=await apiPost('createInvoice',{payload:INV_PREVIEW,user:SESSION}); alert('請求書発行: '+r.inv_id); INV_PREVIEW.inv_id=r.inv_id; openInvoiceDoc(r.inv_id); }
  catch(e){ alert(e.message||e); }
}
async function openInvoiceDoc(inv_id){
  if(!inv_id){ alert('先に請求書を発行してください'); return; }
  try{
    const d=await apiGet({action:'invoiceDoc',inv_id});
    const inv=d.inv, lines=d.lines;
    const body=`<h3>請求書</h3>
      <table>
        <tr><th>請求番号</th><td>${inv.inv_id}</td><th>請求日</th><td>${fmtD(inv['請求日'])}</td></tr>
        <tr><th>得意先</th><td>${inv['得意先']}</td><th>対象期間</th><td>${fmtD(inv['期間自'])} 〜 ${fmtD(inv['期間至'])}</td></tr>
        <tr><th>通貨</th><td>${inv['通貨']||'JPY'}</td><th>備考</th><td>${inv['メモ']||''}</td></tr>
      </table><br>
      <table>
        <thead><tr><th>#</th><th>品名</th><th>品番</th><th>図番</th><th>数量</th><th>単価</th><th>金額</th><th>注番</th><th>出荷ID</th></tr></thead>
        <tbody>${lines.map(l=>`<tr><td>${l['行No']}</td><td>${l['品名']}</td><td>${l['品番']}</td><td>${l['図番']}</td><td>${l['数量']}</td><td>${l['単価']}</td><td>${l['金額']}</td><td>${l['PO']||''}</td><td>${l['出荷ID']||''}</td></tr>`).join('')}</tbody>
        <tfoot>
          <tr><td colspan="5"></td><td>小計</td><td>${inv['小計']}</td><td colspan="2"></td></tr>
          <tr><td colspan="5"></td><td>税額</td><td>${inv['税額']}</td><td colspan="2"></td></tr>
          <tr><td colspan="5"></td><td><b>合計</b></td><td><b>${inv['合計']}</b></td><td colspan="2"></td></tr>
        </tfoot>
      </table>`;
    showDoc('dlgTicket', body);
  }catch(e){ alert(e.message||e); }
}
function exportInvoiceCSV(){
  const rows=[...document.querySelectorAll('#invLines tr')].map(tr=>({ 行No:tr.dataset.no, 品名:tr.dataset.hinmei, 品番:tr.dataset.hinban, 図番:tr.dataset.zuban, 数量:tr.querySelector('.q').value, 単価:tr.querySelector('.p').value, 注番:tr.dataset.po, 出荷ID:tr.dataset.shipid }));
  downloadCSV('invoice_preview.csv', rows);
}

/* ===== Charts page (Pareto + others) ===== */
let CHARTS={};
async function renderChartsPage(){
  const d=await apiGet({action:'charts'});
  const labels=Object.keys(d.defectByProc||{});
  const vals=Object.values(d.defectByProc||{});
  const total=vals.reduce((a,b)=>a+b,0)||1; let cum=0; const cumPct=vals.map(v=> (cum+=v)/total*100 );
  CHARTS.pareto?.destroy();
  CHARTS.pareto=new Chart($('#chartPareto'),{ type:'bar', data:{labels,datasets:[{label:'不良件数(工程別)',data:vals,yAxisID:'y'}]}, options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}, y1:{type:'linear',position:'right',min:0,max:100,ticks:{callback:v=>v+'%'}}}} });
  CHARTS.cust?.destroy(); CHARTS.cust=new Chart($('#chartCustomer'),{type:'pie',data:{labels:Object.keys(d.perCust),datasets:[{data:Object.values(d.perCust)}]}});
  CHARTS.month?.destroy(); CHARTS.month=new Chart($('#chartMonthly'),{type:'bar',data:{labels:['1','2','3','4','5','6','7','8','9','10','11','12'],datasets:[{label:'月別出荷数量（'+d.year+'）',data:d.perMonth}]}});
  CHARTS.stock?.destroy(); CHARTS.stock=new Chart($('#chartStock'),{type:'pie',data:{labels:Object.keys(d.stockBuckets),datasets:[{data:Object.values(d.stockBuckets)}]}});
}

/* ===== Utils ===== */
function fillManualSelectorsIf(){ if(!$('#manualProc').children.length) fillManualSelectors(); }
```
