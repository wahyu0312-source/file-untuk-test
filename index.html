<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>東京精密発條株式会社</title>
  <link rel="icon" href="assets/tsh.png" />
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- PapaParse for CSV import -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* minimal helpers (tidak mengganggu style.css kamu) */
    :root { --bg:#0b0e14; --panel:#111522; --text:#e6e6e6; --muted:#9aa4b2; --accent:#4ea4ff; }
    body { background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px; background:var(--panel); position:sticky; top:0; z-index:20; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.02em; }
    .brand img { width:32px; height:32px; border-radius:8px; }
    .nav { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { padding:8px 12px; border-radius:10px; background:#0d1320; border:1px solid #1c2235; cursor:pointer; }
    .tab.active { background:#121b2e; border-color:#2a3553; box-shadow:0 0 0 2px #1d2844 inset; }
    main { padding:16px; max-width:1200px; margin:0 auto; }
    .grid { display:grid; gap:16px; }
    .g-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .g-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width:980px){ .g-3,.g-2 { grid-template-columns: 1fr; } }
    .tile { background:var(--panel); border:1px solid #1c2235; border-radius:16px; padding:16px; }
    .tile h3 { margin:0 0 10px; font-size:16px; }
    .muted { color:var(--muted); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:6px; width:min(420px,100%); }
    .field label { font-size:12px; color:var(--muted); }
    input, select, textarea { background:#0d1320; color:var(--text); border:1px solid #1c2235; border-radius:10px; padding:10px 12px; outline:none; }
    textarea { min-height:72px; resize:vertical; }
    .btn { background:#18213a; border:1px solid #29365a; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:linear-gradient(180deg,#274a7a,#1a3560); border-color:#2a4b81; }
    .stat { background:#0d1320; border:1px solid #1c2235; border-radius:16px; padding:16px; }
    .stat .kpi { font-size:28px; font-weight:800; }
    .page { display:none; }
    .page.active { display:block; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 12px; border-bottom:1px dashed #233053; text-align:left; font-size:14px; }
    .help { font-size:12px; color:#9aa4b2; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#0f1a2d; border:1px solid #223259; font-size:12px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="assets/tsh.png" alt="TSH" onerror="this.style.display='none'">
      <div>
        <div>東京精密発條株式会社</div>
        <div class="muted" style="font-size:12px">生産ダッシュボード</div>
      </div>
    </div>
    <nav class="nav" id="topNav">
      <button class="tab active" data-goto="dashboard">ダッシュボード</button>
      <button class="tab" data-goto="orders">生産現品票</button>
      <button class="tab" data-goto="ship">出荷予定</button>
      <button class="tab" data-goto="scan">スキャン/手動更新</button>
      <button class="tab" data-goto="settings">設定</button>
    </nav>
  </header>

  <main>
    <!-- KPI -->
    <section class="grid g-3">
      <div class="stat">
        <div class="muted">完成在庫</div>
        <div id="statFinished" class="kpi">—</div>
      </div>
      <div class="stat">
        <div class="muted">出荷準備</div>
        <div id="statReady" class="kpi">—</div>
      </div>
      <div class="stat">
        <div class="muted">出荷済</div>
        <div id="statShipped" class="kpi">—</div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="page-dashboard" class="page active" style="margin-top:16px">
      <div class="grid g-2">
        <div class="tile">
          <h3>不良品（工程別）</h3>
          <div class="help">各工程で記録された不良数量を集計表示します（OK/不良入力に連動）。</div>
          <div style="height:280px">
            <canvas id="chDefects"></canvas>
          </div>
        </div>

        <div class="tile">
          <h3>クイックアクション</h3>
          <div class="row">
            <input id="qa_po" placeholder="注番を入力（例：PO-12345）">
            <button class="btn" id="qa_scan">この注番をスキャン更新</button>
          </div>
          <div class="help">ボタンを押すと ST:◯◯ の入力ダイアログが表示されます。OK品/不良品は必須入力です。</div>
        </div>
      </div>
    </section>

    <!-- 生産現品票 -->
    <section id="page-orders" class="page" style="margin-top:16px">
      <div class="grid g-2">
        <!-- Import CSV -->
        <div class="tile">
          <div class="toolbar">
            <h3>インポート（CSV）— 生産現品票</h3>
            <span class="pill">ヘッダー：生産開始, 得意先, 図番, 機種, 商品名, 数量, 注番, 備考</span>
          </div>
          <input type="file" id="csvOrders" accept=".csv" />
          <div class="help" style="margin-top:8px">CSVを選択するとプレビューが表示され、「取込開始」で登録/更新します（マッピングはサーバ側）。</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnImportOrders">取込開始</button>
            <button class="btn" id="btnClearOrders">プレビュー消去</button>
          </div>
          <div id="previewOrders" class="tile" style="margin-top:12px; background:#0d1320"></div>
        </div>

        <!-- Input Manual -->
        <div class="tile">
          <h3>入力（手動）— 生産現品票</h3>
          <form id="formOrder" class="grid">
            <div class="field">
              <label>注番（空なら自動採番）</label>
              <input name="po_id" placeholder="例：PO-20251009-001">
            </div>
            <div class="field">
              <label>得意先</label>
              <input name="得意先">
            </div>
            <div class="field">
              <label>図番</label>
              <input name="図番">
            </div>
            <div class="field">
              <label>機種</label>
              <input name="機種">
            </div>
            <div class="field">
              <label>商品名</label>
              <input name="商品名">
            </div>
            <div class="field">
              <label>数量</label>
              <input name="数量" type="number" min="0" step="1" value="0">
            </div>
            <div class="field">
              <label>備考</label>
              <textarea name="備考" placeholder="緊急/注意事項など"></textarea>
            </div>
            <div class="row">
              <button class="btn primary" type="submit">登録</button>
              <button class="btn" type="reset">クリア</button>
            </div>
            <div class="help">登録時の既定値：状態=生産開始 / 工程=レザー加工（旧：レーサ加工）</div>
          </form>
        </div>
      </div>
    </section>

    <!-- 出荷予定 -->
    <section id="page-ship" class="page" style="margin-top:16px">
      <div class="grid g-2">
        <!-- Import CSV -->
        <div class="tile">
          <div class="toolbar">
            <h3>インポート（CSV）— 出荷予定</h3>
            <span class="pill">ヘッダー：出荷日, 得意先, 図番, 機種, 商品名, 数量, 送り先, 注番, 備考</span>
          </div>
          <input type="file" id="csvShip" accept=".csv" />
          <div class="help" style="margin-top:8px">CSV内の「注番」をPOに自動リンクします。</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnImportShip">取込開始</button>
            <button class="btn" id="btnClearShip">プレビュー消去</button>
          </div>
          <div id="previewShip" class="tile" style="margin-top:12px; background:#0d1320"></div>
        </div>

        <!-- Input Manual -->
        <div class="tile">
          <h3>入力（手動）— 出荷予定</h3>
          <form id="formShip" class="grid">
            <div class="field">
              <label>注番（PO）</label>
              <input name="po_id" placeholder="例：PO-20251009-001" required>
            </div>
            <div class="field">
              <label>出荷日</label>
              <input name="出荷日" type="date" required>
            </div>
            <div class="field">
              <label>数量</label>
              <input name="数量" type="number" min="0" step="1" value="0">
            </div>
            <div class="field">
              <label>得意先</label>
              <input name="得意先">
            </div>
            <div class="field">
              <label>送り先</label>
              <input name="送り先">
            </div>
            <div class="field">
              <label>備考</label>
              <textarea name="備考"></textarea>
            </div>
            <div class="row">
              <button class="btn primary" type="submit">登録</button>
              <button class="btn" type="reset">クリア</button>
            </div>
            <div class="help">登録後、対象の注番は「出荷準備」へ遷移します。</div>
          </form>
        </div>
      </div>
    </section>

    <!-- スキャン / 手動更新 -->
    <section id="page-scan" class="page" style="margin-top:16px">
      <div class="grid g-2">
        <div class="tile">
          <h3>スキャン（QR/手入力）</h3>
          <div class="row">
            <input id="scan_po" placeholder="注番を入力">
            <button class="btn primary" id="btnScanDialog">スキャン開始</button>
          </div>
          <div class="help" style="margin-top:6px">例：入力ダイアログで <b>ST:検査中</b> や <b>ST:レザー加工</b> を指定。不良/OK必須。</div>
        </div>

        <div class="tile">
          <h3>手動更新（工程を選択してOK/不良を記録）</h3>
          <form id="formManual">
            <div class="field">
              <label>注番</label>
              <input id="m_po" required>
            </div>
            <div class="field">
              <label>工程</label>
              <select id="m_process">
                <option value="レザー加工">レザー加工（旧：レーサ加工）</option>
                <option value="曲げ加工">曲げ加工</option>
                <option value="外枠組立">外枠組立</option>
                <option value="シャッター組立">シャッター組立</option>
                <option value="シャッター溶接">シャッター溶接</option>
                <option value="コーキング">コーキング</option>
                <option value="外枠塗装">外枠塗装</option>
                <option value="組立（組立中）">組立（組立中）</option>
                <option value="組立（組立済）">組立（組立済）</option>
                <option value="外注">外注</option>
                <option value="検査中">検査中</option>
                <option value="検査済">検査済</option>
              </select>
            </div>
            <div class="row">
              <div class="field">
                <label>OK品 数量</label>
                <input id="m_ok" type="number" min="0" step="1" value="0">
              </div>
              <div class="field">
                <label>不良品 数量</label>
                <input id="m_ng" type="number" min="0" step="1" value="0">
              </div>
            </div>
            <div class="field">
              <label>備考</label>
              <textarea id="m_note" placeholder="メモ/原因など"></textarea>
            </div>
            <div class="row">
              <button class="btn primary" type="submit">更新</button>
              <button class="btn" type="reset">クリア</button>
            </div>
            <div class="help">検査部は「検査中/検査済」への更新権限があります。</div>
          </form>
        </div>
      </div>
    </section>

    <!-- 設定 -->
    <section id="page-settings" class="page" style="margin-top:16px">
      <div class="tile">
        <h3>接続設定</h3>
        <div class="help">
          フロントの <code>app.js</code> にある <code>API_BASE</code> を、Apps Script の WebアプリURLに設定してください。<br>
          例）<code>const API_BASE = "https://script.google.com/macros/s/XXXX/exec"</code>
        </div>
        <div style="margin-top:10px">
          <button class="btn" id="btnReLogin">再ログイン</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Frontend core -->
  <script src="app.js"></script>

  <!-- Page wiring -->
  <script>
    // ======= Tab navigation =======
    const tabs = document.querySelectorAll('.tab');
    const pages = {
      dashboard: document.getElementById('page-dashboard'),
      orders: document.getElementById('page-orders'),
      ship: document.getElementById('page-ship'),
      scan: document.getElementById('page-scan'),
      settings: document.getElementById('page-settings'),
    };
    function goto(id){
      Object.values(pages).forEach(p=>p.classList.remove('active'));
      pages[id].classList.add('active');
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.goto===id));
      // redraw chart when needed
      if(id==='dashboard' && typeof renderDefectsChart==='function'){ renderDefectsChart().catch(()=>{}); }
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> goto(t.dataset.goto)));

    // ======= Dashboard quick scan =======
    document.getElementById('qa_scan').addEventListener('click', ()=>{
      const po = String(document.getElementById('qa_po').value||'').trim();
      if(!po) return alert('注番を入力してください');
      if(typeof startScanFor==='function'){ startScanFor(po); } else { alert('app.js が読み込まれていません'); }
    });

    // ======= Scan page: open scan dialog =======
    document.getElementById('btnScanDialog').addEventListener('click', ()=>{
      const po = String(document.getElementById('scan_po').value||'').trim();
      if(!po) return alert('注番を入力してください');
      if(typeof startScanFor==='function'){ startScanFor(po); }
    });

    // ======= Manual update (setProcess with OK/NG) =======
    document.getElementById('formManual').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const po = document.getElementById('m_po').value.trim();
        const process = document.getElementById('m_process').value;
        const ok = Number(document.getElementById('m_ok').value||0);
        const ng = Number(document.getElementById('m_ng').value||0);
        const note = document.getElementById('m_note').value||'';
        if(!po) return alert('注番が必要です');
        if(typeof apiPost!=='function') return alert('app.js が読み込まれていません');
        await apiPost('setProcess',{ user: window.SESSION, po_id: po, process, options:{ ok_qty:ok, ng_qty:ng, note } });
        alert('更新しました'); document.getElementById('formManual').reset();
        if(typeof refreshAll==='function') refreshAll(true);
      }catch(err){ alert(err.message||err); }
    });

    // ======= CSV helpers =======
    let parsedOrders = null, parsedShip = null;
    const prevOrders = document.getElementById('previewOrders');
    const prevShip = document.getElementById('previewShip');
    function renderPreview(el, rows){
      if(!rows || !rows.length){ el.innerHTML = '<div class="muted">プレビューなし</div>'; return; }
      const head = Object.keys(rows[0]);
      const thead = '<thead><tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
      const body = rows.slice(0,50).map(r=>'<tr>'+head.map(h=>`<td>${(r[h]??'')}</td>`).join('')+'</tr>').join('');
      el.innerHTML = `<div class="help" style="margin-bottom:8px">${rows.length} 行を検出（最大50行を表示）</div>
                      <div style="max-height:240px; overflow:auto"><table>${thead}<tbody>${body}</tbody></table></div>`;
    }
    document.getElementById('csvOrders').addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      Papa.parse(f,{ header:true, skipEmptyLines:true, complete:(res)=>{ parsedOrders = res.data||[]; renderPreview(prevOrders, parsedOrders); }});
    });
    document.getElementById('csvShip').addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      Papa.parse(f,{ header:true, skipEmptyLines:true, complete:(res)=>{ parsedShip = res.data||[]; renderPreview(prevShip, parsedShip); }});
    });
    document.getElementById('btnClearOrders').addEventListener('click', ()=>{ parsedOrders=null; prevOrders.innerHTML=''; });
    document.getElementById('btnClearShip').addEventListener('click', ()=>{ parsedShip=null; prevShip.innerHTML=''; });

    // ======= Import actions =======
    document.getElementById('btnImportOrders').addEventListener('click', async ()=>{
      try{
        if(!parsedOrders?.length) return alert('CSVを選択してください');
        if(typeof apiPost!=='function') return alert('app.js が読み込まれていません');
        const r=await apiPost('importOrders',{ rows: parsedOrders, user: window.SESSION, mode:'upsert' });
        alert(`登録:${r.created} / 更新:${r.updated}`); if(typeof refreshAll==='function') refreshAll(true);
      }catch(err){ alert(err.message||err); }
    });
    document.getElementById('btnImportShip').addEventListener('click', async ()=>{
      try{
        if(!parsedShip?.length) return alert('CSVを選択してください');
        if(typeof apiPost!=='function') return alert('app.js が読み込まれていません');
        const r=await apiPost('importShipments',{ rows: parsedShip, user: window.SESSION, mode:'upsert' });
        alert(`登録:${r.created} / 更新:${r.updated}`); if(typeof refreshAll==='function') refreshAll(true);
      }catch(err){ alert(err.message||err); }
    });

    // ======= Manual forms (create order / schedule shipment) =======
    document.getElementById('formOrder').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const fd = new FormData(e.target);
        const payload = {
          po_id: (fd.get('po_id')||'').toString().trim(),
          '得意先': fd.get('得意先')||'',
          '図番': fd.get('図番')||'',
          '機種': fd.get('機種')||'',
          '商品名': fd.get('商品名')||'',
          '数量': Number(fd.get('数量')||0),
          '備考': fd.get('備考')||'',
          status: '生産開始',
          current_process: 'レザー加工'
        };
        if(typeof apiPost!=='function') return alert('app.js が読み込まれていません');
        const r = await apiPost('createOrder',{ payload, user: window.SESSION });
        alert(`登録しました（注番: ${r.po_id}）`); e.target.reset();
        if(typeof refreshAll==='function') refreshAll(true);
      }catch(err){ alert(err.message||err); }
    });

    document.getElementById('formShip').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const fd = new FormData(e.target);
        const po_id = (fd.get('po_id')||'').toString().trim();
        if(!po_id) return alert('注番が必要です');
        const dateIso = fd.get('出荷日');
        const qty = Number(fd.get('数量')||0);
        const extra = { '得意先': fd.get('得意先')||'', '送り先': fd.get('送り先')||'', '備考': fd.get('備考')||'' };
        if(typeof apiPost!=='function') return alert('app.js が読み込まれていません');
        const r = await apiPost('scheduleShipment',{ po_id, dateIso, qty, user: window.SESSION, extra });
        alert(`出荷予定を登録しました（ID: ${r.ship_id}）`); e.target.reset();
        if(typeof refreshAll==='function') refreshAll(true);
      }catch(err){ alert(err.message||err); }
    });

    // ======= Settings: re-login =======
    document.getElementById('btnReLogin').addEventListener('click', async ()=>{
      try{
        localStorage.removeItem('erp_session');
        if(typeof window.refreshAll==='function'){ await refreshAll(true); }
        alert('ログイン情報をクリアしました。ページを再読み込みしてください。');
      }catch{}
    });
  </script>
</body>
</html>
