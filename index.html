<!DOCTYPE html>
<html lang="ja">
<head>
  </head>
<body>
  <script>
// ##################################################################
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0sWPTgOtYl2kFq8nMbm0Ax_UGUbj48A-y1FmmZwGjyTDFXlAuSqTvwgPp_vZ-Ed8OPg/exec"; 
// ##################################################################
let CURRENT_USER = "";

document.addEventListener('DOMContentLoaded', () => {
    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app-page');
    
    // Fungsi umum untuk fetch
    async function postToAction(payload) {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            redirect: 'follow'
        });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        if (!response.ok) throw new Error('Network response was not ok.');
        return result;
    }

    function showLoginPage() {
      appPage.style.display = 'none';
      loginPage.innerHTML = `...`; // (HTML login form)
      loginPage.style.display = 'block';
      
      const nameSelect = document.getElementById('name');
      nameSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

      postToAction({ action: 'getWebUserNameList' })
        .then(names => {
          nameSelect.innerHTML = '<option value="" disabled selected>名前を選択</option>';
          if (names && names.length > 0) names.forEach(name => nameSelect.innerHTML += `<option value="${name}">${name}</option>`);
        })
        .catch(err => nameSelect.innerHTML = `<option value="" disabled>Gagal memuat user: ${err.message}</option>`);

      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }
    
    function handleLogin(e){ /* ... (Sama seperti sebelumnya) ... */ }
    function showAppPage(userName) { /* ... (Sama seperti sebelumnya) ... */ }

    async function loadInitialData() {
      const listContainer = document.getElementById('shipment-list');
      const hideShipped = document.getElementById('hide-shipped-checkbox').checked;
      listContainer.innerHTML = '<div class="loader">読み込み中...</div>';
      try {
        const data = await postToAction({ action: 'getRecentShipments', hideShipped: hideShipped });
        displayTable(data);
      } catch (err) { listContainer.innerHTML = `<div class="message">${err.message}</div>`; }
    }
    
    // ... (displayTable dan fungsi UI lainnya tetap sama) ...
    
    async function switchToEditMode(updateBtn) {
        // ... (Fungsi ini diubah untuk menggunakan postToAction)
        try {
          const res = await postToAction({ action: 'getProductDetails', searchKey: searchKey });
          // ... (sisa logika sama)
        } catch(err) { /* ... */ }
    }
    
    async function handleStatusChange(e) {
        // ... (Fungsi ini diubah untuk menggunakan postToAction)
        try {
            const result = await postToAction({ 
              action: 'updateProductStatus',
              updater: CURRENT_USER,
              searchKey: searchKey,
              newStatus: newStatus
            });
            if (!result.ok) throw new Error(result.msg);
            loadInitialData();
        } catch (err) {
            alert('Update Gagal: ' + err.message);
            loadInitialData();
        }
    }
    
    // ... (Semua event listener lainnya disesuaikan untuk memanggil fungsi async yang baru)
});
</script>
</body>
</html>
