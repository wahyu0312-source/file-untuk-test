<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出荷検査システム</title>
  <style>
    :root { 
      --primary-color: #34495E; --secondary-color: #F5F7FA; --border-color: #EAECEE; --shadow: 0 4px 12px rgba(0,0,0,0.08); 
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      background-color: var(--secondary-color); margin: 0; font-size: 14px; 
    }
    .container { width: 95%; max-width: 1200px; margin: 1.5rem auto; background-color: #fff; box-shadow: var(--shadow); border-radius: 8px; }
    .header { background-color: var(--primary-color); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
    .header-controls { display: flex; align-items: center; gap: 1rem; }
    .content { padding: 1.5rem; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
    .search-bar { display: flex; gap: 0.5rem; flex-grow: 1; min-width: 300px; }
    .filter-bar { display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
    input, select, button { font-family: inherit; font-size: 1rem; }
    input[type="text"], select { width:100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 5px; }
    .action-button { background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1rem; border-radius: 5px; cursor: pointer; font-weight: 500; }
    .table-container { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    th { background-color: #F8F9FA; font-size: 0.8rem; }
    tr.is-editing { background-color: #FEF9E7 !important; }
    .status-badge { padding: 0.2em 0.6em; border-radius: 10px; color: white; font-size: 0.8rem; display: inline-block; }
    .status-完了, .status-完成 { background-color: #27AE60; } .status-検査中 { background-color: #F39C12; } .status-保留 { background-color: #E74C3C; } .status-検査待ち { background-color: #85929E; } .status-出荷済 { background-color: #3498DB; }
    .update-row-btn { background-color: #ECF0F1; border: 1px solid #BDC3C7; color: #34495E; padding: 0.3rem 0.8rem; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    .loader { text-align: center; padding: 2rem; }
    .message { padding: 1rem; text-align: center; border-radius: 5px; background-color:#FADBD8; color:#C0392B; }
  </style>
</head>
<body>
  <div id="login-page"></div>
  <div id="app-page" class="container" style="display:none;">
    <div class="header"><h3>出荷検査システム</h3><div class="header-controls"><span id="user-display"></span></div></div>
    <div class="content">
      <div class="controls-bar">
        <div class="search-bar"><input type="text" id="search-input" placeholder="図番で検索..."><button id="search-btn" class="action-button">検索</button></div>
        <div class="filter-bar"><input type="checkbox" id="hide-shipped-checkbox"><label for="hide-shipped-checkbox">Sembunyikan status [出荷済]</label></div>
      </div>
      <div class="table-container" id="shipment-list"><div class="loader">読み込み中...</div></div>
    </div>
  </div>
<script>
// ##################################################################
// # PENTING: GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT ANDA #
// ##################################################################
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0sWPTgOtYl2kFq8nMbm0Ax_UGUbj48A-y1FmmZwGjyTDFXlAuSqTvwgPp_vZ-Ed8OPg/exec"; 
// ##################################################################

let CURRENT_USER = "";

document.addEventListener('DOMContentLoaded', () => {
    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app-page');
    
    async function postToAction(payload) {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            redirect: 'follow'
        });
        if (!response.ok) throw new Error('Network response was not ok.');
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        return result;
    }

    function showLoginPage() {
      appPage.style.display = 'none';
      loginPage.innerHTML = `<div style="max-width:480px; margin: 5rem auto; background: #fff; border-radius:8px; box-shadow: var(--shadow);"><div class="header" style="text-align:center; display:block;">出荷検査システム</div><div class="content"><form id="login-form"><div style="margin-bottom:1rem;"><label for="name" style="display:block; margin-bottom:0.5rem;">ログイン者を選択</label><select id="name" required style="width:100%; padding:0.75rem; border:1px solid var(--border-color);"></select></div><button type="submit" class="action-button" style="width:100%;">Masuk</button><div id="login-msg" class="message" style="display:none;"></div></form></div></div>`;
      loginPage.style.display = 'block';
      
      const nameSelect = document.getElementById('name');
      nameSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

      postToAction({ action: 'getWebUserNameList' })
        .then(names => {
          nameSelect.innerHTML = '<option value="" disabled selected>名前を選択</option>';
          if (names && names.length > 0) names.forEach(name => nameSelect.innerHTML += `<option value="${name}">${name}</option>`);
        })
        .catch(err => {
          const msgEl = document.getElementById('login-msg');
          msgEl.textContent = `Gagal memuat user: ${err.message}`;
          msgEl.style.display = 'block';
        });

      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }
    
    function handleLogin(e){
      e.preventDefault();
      const userName = document.getElementById('name').value;
      if (!userName) { alert("Pilih nama Anda."); return; }
      CURRENT_USER = userName;
      showAppPage(CURRENT_USER);
    }

    function showAppPage(userName) {
      loginPage.style.display = 'none'; appPage.style.display = 'block';
      document.getElementById('user-display').textContent = `ユーザー: ${userName}`;
      loadInitialData();
    }

    async function loadInitialData() {
      const listContainer = document.getElementById('shipment-list');
      const hideShipped = document.getElementById('hide-shipped-checkbox').checked;
      listContainer.innerHTML = '<div class="loader">読み込み中...</div>';
      try {
        const data = await postToAction({ action: 'getRecentShipments', hideShipped: hideShipped });
        displayTable(data);
      } catch (err) { listContainer.innerHTML = `<div class="message">${err.message}</div>`; }
    }
    
    function getStatusClassName(statusText) {
      // ... (fungsi ini sama seperti sebelumnya)
    }

    function displayTable(data, isSearchResult = false) {
      // ... (fungsi ini sama seperti sebelumnya)
    }
    
    async function switchToEditMode(updateBtn) {
      // ... (fungsi ini diubah untuk menggunakan postToAction)
    }
    
    async function handleStatusChange(e) {
      // ... (fungsi ini diubah untuk menggunakan postToAction)
    }

    // ... (Semua event listener sama seperti sebelumnya)

    showLoginPage();
});
</script>
</body>
</html>
